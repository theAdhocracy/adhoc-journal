---
import { checkAuth } from "@/utils/auth";
import { standardiseDateRoute, validDateRoute } from "@/utils/dateRoutes";

const { year, month, day } = Astro.params;

// Authenticated route
const isAuthenticated = checkAuth(Astro.cookies.get("auth"));

if (!isAuthenticated) {
	const currentPath = Astro.url.pathname;
	return Astro.redirect(`/login?path=${currentPath}`);
}

// Validate route
const isValid = validDateRoute(year, month, day);

if (!isValid) {
	return Astro.redirect("/404");
}

// Standardise date
const apiDate = standardiseDateRoute(
	day as string,
	month as string,
	year as string
);

// Fetch page data
const data = await fetch(
	`https://cms.theadhocracy.co.uk/journal/${apiDate}.json`,
	{
		method: "GET",
		headers: {
			"content-type": "application/json",
			Authorization: `Bearer ${import.meta.env.CRAFT_API_KEY}`,
		},
	}
);
const response = await data.json();
---

{
	isAuthenticated && response && (
		<>
			<h1>
				{year} - {month} - {day}
			</h1>

			<p>{response.title}</p>

			{response.error && <p>Doesn't look like I was very busy today ü§∑‚Äç‚ôÄÔ∏è</p>}
		</>
	)
}
